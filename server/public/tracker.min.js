var Tracker=function(){"use strict";var n={events:["click"],uploadType:"immedite",mode:"sample"},c="TRACKER/BATTERY",g="TRACKER/LOCATION",v="TRACKER/DATA";function m(e){if(!e)return"";if(e.id)return"#"+e.id;var t=e.tagName.toLowerCase();return e.className?t+"."+e.className.split(/\s+/).join("."):t}function i(e){return JSON.parse(localStorage.getItem(e))}function t(){var e,t=navigator.appVersion,n=i(c),o=i(g),a=(e=navigator.connection)?{effectiveType:e.effectiveType,rtt:e.rtt,downlink:e.downlink}:"",r=navigator.language;return{version:t,platform:navigator.platform,language:r,battery:n,connection:a,online:navigator.onLine,position:o}}function e(e){var t=this;this._eventHandler=function(e){t._handleEvent(e)},this._config=Object.assign({},n,e)}return e.prototype.regist=function(){for(var e,t,n=this,o=this._config,a=o.events,r=o.uploadType,i=0;i<a.length;i+=1){var l=a[i];document.body.addEventListener(l,this._eventHandler)}return window.addEventListener("beforeunload",function(){n._uploadBaseInfo(),"unload"!==r&&n._uploadUnload()}),t=navigator,(e=t.battery||t.mozBattery||t.webkitBattery)?localStorage.setItem(c,JSON.stringify(e)):"function"==typeof t.getBattery&&t.getBattery().then(function(e){var t={charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime,level:e.level};localStorage.setItem(c,JSON.stringify(t))}),"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(e){var t={long:e.coords.longitude,lat:e.coords.latitude};localStorage.setItem(g,JSON.stringify(t))}),this},e.prototype.removeWith=function(e){document.body.removeEventListener(e,this._eventHandler)},e.prototype._handleEvent=function(e){var t,n,o,a,r,i,l,c=this._config.uploadType,g=e.target,s=function(e){for(var t=[];e;){var n=m(e);if(!n)break;var o=e.parentElement,a=o.childElementCount,r=o.children;if(1<a)for(var i=0;i<a;i+=1)if(r[i]===e){n=n+":nth-child("+(i+1)+")";break}if(t.unshift(n),n.includes("body")||document.querySelector(t.join(">"))===e)break;e=e.parentElement}return t.join(">")}(g),u=(n=(t=e).target.getBoundingClientRect(),o=n.left,a=n.top,r=document.documentElement,i=r.scrollLeft,l=r.scrollTop,[t.pageX-i-o,t.pageY-l-a]),d={nodeName:g.nodeName.toLowerCase(),type:e.type,path:encodeURIComponent(s),position:u};if("immedite"===c)this._upload(d);else{var f=JSON.parse(localStorage.getItem(v)),p=[d];f&&p.push.apply(p,f),localStorage.setItem(v,JSON.stringify(p))}},e.prototype._upload=function(e){var t=this._config.uploadUrl,n=new Image(0,0);n.src=t+"?"+function(e){for(var t=[],n=0,o=Object.keys(e);n<o.length;n++){var a=o[n];t.push(a+"="+e[a])}return t.join("&")}(e),n.onload=function(){n=null}},e.prototype._uploadUnload=function(){var e=localStorage.getItem(v);localStorage.removeItem(v),e&&navigator.sendBeacon("/upload",e)},e.prototype._uploadBaseInfo=function(){var e=t();navigator.sendBeacon("/info",JSON.stringify(e))},e}();
