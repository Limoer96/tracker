var Tracker=function(){"use strict";var n={events:["click"],uploadType:"immedite",mode:"sample"},l="TRACKER/BATTERY",c="TRACKER/LOCATION",v="TRACKER/DATA";function m(e){if(!e)return"";if(e.id)return"#"+e.id;var t=e.tagName.toLowerCase();return e.className?t+"."+e.className.split(/\s+/).join("."):t}function r(e){return JSON.parse(localStorage.getItem(e))}function o(){var e,t=navigator.appVersion,n=r(l),o=r(c),a=(e=navigator.connection)?{effectiveType:e.effectiveType,rtt:e.rtt,downlink:e.downlink}:"",i=navigator.language;return{version:t,platform:navigator.platform,language:i,battery:n,connection:a,online:navigator.onLine,position:o}}function e(e){var t=this;this._eventHandler=function(e){t._handleEvent(e)},this._config=Object.assign({},n,e)}return e.prototype.regist=function(){for(var e,t,n=this,o=this._config,a=o.events,i=(o.uploadType,0);i<a.length;i+=1){var r=a[i];document.body.addEventListener(r,this._eventHandler)}return window.addEventListener("beforeunload",function(){n._uploadBaseInfo(),n._uploadUnload()}),t=navigator,(e=t.battery||t.mozBattery||t.webkitBattery)?localStorage.setItem(l,JSON.stringify(e)):"function"==typeof t.getBattery&&t.getBattery().then(function(e){var t={charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime,level:e.level};localStorage.setItem(l,JSON.stringify(t))}),"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(e){var t={long:e.coords.longitude,lat:e.coords.latitude};localStorage.setItem(c,JSON.stringify(t))}),this},e.prototype.removeWith=function(e){document.body.removeEventListener(e,this._eventHandler)},e.prototype._handleEvent=function(e){var t,n,o,a,i,r,l,c=this._config.uploadType,g=e.target,s=function(e){for(var t=[];e;){var n=m(e);if(!n)break;var o=e.parentElement,a=o.childElementCount,i=o.children;if(1<a)for(var r=0;r<a;r+=1)if(i[r]===e){n=n+":nth-child("+(r+1)+")";break}if(t.unshift(n),n.includes("body")||document.querySelector(t.join(">"))===e)break;e=e.parentElement}return t.join(">")}(g),u=(n=(t=e).target.getBoundingClientRect(),o=n.left,a=n.top,i=document.documentElement,r=i.scrollLeft,l=i.scrollTop,[t.pageX-r-o,t.pageY-l-a]),d={nodeName:g.nodeName.toLowerCase(),type:e.type,path:encodeURIComponent(s),position:u};if("immedite"===c)this._upload(d);else{var p=JSON.parse(localStorage.getItem(v)),f=[d];p&&f.push.apply(f,p),localStorage.setItem(v,JSON.stringify(f))}},e.prototype._upload=function(e){var t=this._config.uploadUrl,n=new Image(0,0);n.src=t+"/upload?"+function(e){for(var t=[],n=0,o=Object.keys(e);n<o.length;n++){var a=o[n];t.push(a+"="+e[a])}return t.join("&")}(e),n.onload=function(){n=null}},e.prototype._uploadUnload=function(){var e=this._config.uploadUrl,t=localStorage.getItem(v);localStorage.removeItem(v),t&&navigator.sendBeacon(e+"/upload",t)},e.prototype._uploadBaseInfo=function(){var e=this._config.uploadUrl,t=o();navigator.sendBeacon(e+"/info",JSON.stringify(t))},e}();
