var Tracker=function(){"use strict";var a={events:["click"],uploadType:"immedite",mode:"sample"},c="TRACKER/BATTERY",d="TRACKER/LOCATION",v="TRACKER/DATA",l="ERROR/UPLOAD_DATA";function h(e){if(!e)return"";if(e.id)return"#"+e.id;var t=e.tagName.toLowerCase();return e.className?t+"."+e.className.split(/\s+/).join("."):t}function n(){var e,t,n,o=navigator.appVersion,a=s.get(c),r=s.get(d),i=(e=navigator.connection)?{effectiveType:e.effectiveType,rtt:e.rtt,downlink:e.downlink}:"",l=navigator.language;return{version:o,platform:navigator.platform,language:l,battery:a,connection:i,online:navigator.onLine,position:r,timing:(t=window.performance.timing,n=t.navigationStart,{redirect:t.redirectEnd-t.redirectStart,appCache:t.domainLookupStart-t.fetchStart,dns:t.domainLookupEnd-t.domainLookupStart,tcp:t.connectEnd-t.connectStart,ttfb:t.responseStart-t.requestStart,downloaded:t.responseEnd-t.responseEnd,http:t.responseEnd-t.requestStart,domloaded:t.domContentLoadedEventEnd-n,loaded:t.loadEventEnd-n})}}var t,s={getRaw:function(e){return localStorage.getItem(e)},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(localStorage.getItem(e))},append:function(e,t){if(s.getRaw(e)){var n=s.get(e);"[object Array]"!==Object.prototype.toString.call(n)&&(n=[n]);var o=[t];n&&o.push.apply(o,n),s.set(e,o)}else s.set(e,[t])},remove:function(e){localStorage.removeItem(e)},clear:function(){localStorage.clear()}},e=(o.prototype.regist=function(){for(var e=this,t=this._config.events,n=0;n<t.length;n+=1)document.body.addEventListener(t[n],this._eventHandler);return window.addEventListener("beforeunload",function(){e._uploadBaseInfo(),e._uploadUnload()}),this},o.prototype.removeWith=function(e){document.body.removeEventListener(e,this._eventHandler)},o.prototype._handleEvent=function(e){var t,n,o,a,r,i,l,c=this._config.uploadType,d=e.target,s=function(e){for(var t=[];e;){var n=h(e);if(!n)break;var o=e.parentElement,a=o.childElementCount,r=o.children;if(1<a)for(var i=0;i<a;i+=1)if(r[i]===e){n=n+":nth-child("+(i+1)+")";break}if(t.unshift(n),n.includes("body")||document.querySelector(t.join(">"))===e)break;e=e.parentElement}return t.join(">")}(d),g=(n=(t=e).target.getBoundingClientRect(),o=n.left,a=n.top,r=document.documentElement,i=r.scrollLeft,l=r.scrollTop,[t.pageX-i-o,t.pageY-l-a]),u=location.href,p={nodeName:d.nodeName.toLowerCase(),type:e.type,path:encodeURIComponent(s),position:g,url:u};if("immedite"===c)this._upload(p);else{var f=JSON.parse(localStorage.getItem(v)),m=[p];f&&m.push.apply(m,f),localStorage.setItem(v,JSON.stringify(m))}},o.prototype._upload=function(e){var t=this._config.uploadUrl,n=new Image(1,1);n.src=t+"/upload?"+function(e){for(var t=[],n=0,o=Object.keys(e);n<o.length;n++){var a=o[n];t.push(a+"="+e[a])}return t.join("&")}(e),n.onload=function(){n=null}},o.prototype._uploadUnload=function(){var e=this._config.uploadUrl,t=localStorage.getItem(v);localStorage.removeItem(v),t&&navigator.sendBeacon(e+"/upload",t)},o.prototype._uploadBaseInfo=function(){var e=this._config.uploadUrl,t=n();console.log("result",t),navigator.sendBeacon(e+"/info",JSON.stringify(t))},o);function o(e){var t,n,o=this;this._eventHandler=function(e){o._handleEvent(e)},this._config=Object.assign({},a,e),n=navigator,(t=n.battery||n.mozBattery||n.webkitBattery)?localStorage.setItem(c,JSON.stringify(t)):"function"==typeof n.getBattery&&n.getBattery().then(function(e){var t={charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime,level:e.level};localStorage.setItem(c,JSON.stringify(t))}),"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(e){var t={long:e.coords.longitude,lat:e.coords.latitude,timestamp:e.timestamp};localStorage.setItem(d,JSON.stringify(t))})}return t="http://localhost:3001/error",window.addEventListener("error",function(e){e&&function(e,t,n,o,a,r){if(t){var i={filename:n,message:e,line:o,col:a,error:r,time:Date.now()};s.append(l,i)}}(e.message,t,e.filename,e.lineno,e.colno,e.error.toString())}),window.addEventListener("beforeunload",function(){var e=s.getRaw(l);s.remove(l),navigator.sendBeacon(t,e)}),e}();
